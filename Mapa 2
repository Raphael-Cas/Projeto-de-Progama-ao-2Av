#include <stdio.h>
#include <windows.h>
#include <conio.h>
#include <stdlib.h>
#include <time.h>

#define TAM 20

void moverCursor(int x, int y) {
    COORD pos = { x * 2, y };
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), pos);
}

void desenharMapa(char mapa[TAM][TAM], int vidas) {
    system("cls");
    for (int i = 0; i < TAM; i++) {
        for (int j = 0; j < TAM; j++) {
            printf("%c ", mapa[i][j]);
        }
        printf("\n");
    }
    printf("\nUse W A S D para mover, Q para sair. Pressione 'I' para interagir. Chave: %s | Tentativas restantes: %d\n",
           vidas < 3 ? "SIM" : "NAO", vidas);
}

void inicializarMapa(char mapa[TAM][TAM], int *px, int *py, int *ex, int *ey, int *temChave) {
    *temChave = 0;
    *px = 1; *py = 1;
    *ex = TAM - 2; *ey = TAM - 2;

    for (int i = 0; i < TAM; i++) {
        for (int j = 0; j < TAM; j++) {
            mapa[i][j] = '.';
        }
    }

    for (int i = 0; i < TAM; i++) {
        mapa[0][i] = '#';
        mapa[TAM-1][i] = '#';
        mapa[i][0] = '#';
        mapa[i][TAM-1] = '#';
    }

    mapa[3][3] = '#'; mapa[3][4] = '#'; mapa[3][5] = '#';
    mapa[4][3] = '#'; mapa[5][3] = '#';
    mapa[8][8] = '#'; mapa[8][9] = '#'; mapa[8][10] = '#';
    mapa[9][10] = '#'; mapa[10][10] = '#';

    mapa[2][12] = '\\'; mapa[2][13] = '/';
    mapa[3][12] = '|';  mapa[3][13] = '|';
    mapa[4][12] = '#';  mapa[4][13] = '#';

    mapa[6][16] = '\\'; mapa[6][17] = '/';
    mapa[7][16] = '|';  mapa[7][17] = '|';
    mapa[8][16] = '#';  mapa[8][17] = '#';

    mapa[10][5] = 'D';
    mapa[14][18] = '@';

    mapa[*py][*px] = '&';
    mapa[*ey][*ex] = 'X';
}

void moverInimigo(char mapa[TAM][TAM], int *ex, int *ey) {
    int dx[] = {0, 0, -1, 1};
    int dy[] = {-1, 1, 0, 0};

    int direcao = rand() % 4;
    int nx = *ex + dx[direcao];
    int ny = *ey + dy[direcao];

    if (mapa[ny][nx] == '.' || mapa[ny][nx] == '&') {
        mapa[*ey][*ex] = '.';
        *ex = nx;
        *ey = ny;
        mapa[*ey][*ex] = 'X';
    }
}

int main() {
    char mapa[TAM][TAM];
    int px, py;
    int ex, ey;
    int temChave = 0;
    int vidas = 2;
    char tecla;

    srand(time(NULL));

    inicializarMapa(mapa, &px, &py, &ex, &ey, &temChave);

    while (1) {
        desenharMapa(mapa, vidas);

        if (px == ex && py == ey) {
            vidas--;
            if (vidas < 0) {
                printf("\nGame Over!\n");
                break;
            } else {
                printf("\nVocê foi pego! Reiniciando...\n");
                Sleep(2000);
                inicializarMapa(mapa, &px, &py, &ex, &ey, &temChave);
                continue;
            }
        }

        tecla = _getch();

        if (tecla == 'q' || tecla == 'Q')
            break;

        mapa[py][px] = '.';

        int nx = px, ny = py;

        if (tecla == 'w' || tecla == 'W') ny--;
        if (tecla == 's' || tecla == 'S') ny++;
        if (tecla == 'a' || tecla == 'A') nx--;
        if (tecla == 'd' || tecla == 'D') nx++;

        if (mapa[ny][nx] != '#' && mapa[ny][nx] != 'X') {
            px = nx;
            py = ny;
        }

        if (tecla == 'i' || tecla == 'I') {
            if (mapa[py][px] == 'D' && temChave) {
                printf("Você abriu a porta!\n");
                Sleep(1000);
                mapa[py][px] = '.';
            } else if (mapa[py][px] == '@') {
                printf("Você pegou a chave!\n");
                Sleep(1000);
                temChave = 1;
                mapa[py][px] = '.';
            } else {
                printf("Nada para interagir aqui.\n");
                Sleep(1000);
            }
        }

        mapa[py][px] = '&';

        moverInimigo(mapa, &ex, &ey);
    }

    return 0;
}
